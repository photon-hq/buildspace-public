name: Label Check

on:
  workflow_call:
    inputs:
      label-name:
        type: string
        required: false
        default: "" 
        description: "The label name to check for (case-insensitive)"
    outputs:
      exists:
        description: "true if label exists, false otherwise"
        value: ${{ jobs.check.outputs.exists }}

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      exists: ${{ steps.check-label.outputs.exists }}
    steps:
      - name: Check for label
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const labelToFind = '${{ inputs.label-name }}'.toLowerCase();
            
            // If triggered by pull_request event, use the PR number directly
            if (context.eventName === 'pull_request') {
              const prNumber = context.payload.pull_request.number;
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              const labels = pr.labels.map(l => l.name.toLowerCase());
              const found = labels.includes(labelToFind);
              core.setOutput('exists', found ? 'true' : 'false');
              return;
            }
            
            // For push events, find PR for this branch
            const currentRef = context.ref;
            const branchName = currentRef.replace('refs/heads/', '');
            
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });
            
            if (prs.length === 0) {
              core.setOutput('exists', 'false');
              return;
            }
            
            const pr = prs[0];
            const labels = pr.labels.map(l => l.name.toLowerCase());
            const found = labels.includes(labelToFind);
            core.setOutput('exists', found ? 'true' : 'false');
