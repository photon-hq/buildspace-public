name: Rust Binary Release

on:
  workflow_call:
    inputs:
      service-name:
        type: string
        required: true
        description: "The name of the service to release"
      binary-name:
        type: string
        required: true
        description: "The name of the binary to build (crate name)"
      binary-path:
        type: string
        required: false
        default: ""
        description: "Path to the crate if in a workspace (e.g., crates/client)"
      prerelease:
        type: boolean
        required: false
        default: false
        description: "Whether to create a prerelease"
      github-release:
        type: boolean
        required: false
        default: true
        description: "Whether to create a GitHub release"
      targets:
        type: string
        required: false
        default: "x86_64-unknown-linux-gnu,x86_64-apple-darwin,aarch64-apple-darwin,x86_64-pc-windows-msvc"
        description: "Comma-separated list of Rust targets to build"
    secrets:
      OPENAI_API_KEY:
        required: true
        description: "OpenAI API key for determining version and generating release notes"

jobs:
  # Step 1: Check for release label
  label-check:
    uses: ./.github/workflows/label-check.yml
    with:
      label-name: "release"

  # Step 2: Generate release info (version + notes)
  release-info:
    needs: label-check
    if: needs.label-check.outputs.exists == 'true'
    uses: ./.github/workflows/generate-release-info.yml
    with:
      service-name: ${{ inputs.service-name }}
      prerelease: ${{ inputs.prerelease }}
      force-release: true  # If label exists, always release
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  # Step 3: Build binaries for all targets
  build-binaries:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: release-info
    if: needs.release-info.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Build binary
        run: |
          if [ -n "${{ inputs.binary-path }}" ]; then
            cargo build --release --target ${{ matrix.target }} -p ${{ inputs.binary-name }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        shell: bash

      - name: Prepare artifact (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/${{ inputs.binary-name }} artifacts/${{ inputs.binary-name }}-${{ matrix.target }}
          chmod +x artifacts/${{ inputs.binary-name }}-${{ matrix.target }}

      - name: Prepare artifact (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/${{ inputs.binary-name }}.exe artifacts/${{ inputs.binary-name }}-${{ matrix.target }}.exe
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.binary-name }}-${{ matrix.target }}
          path: artifacts/*

  # Step 4: Create GitHub Release with binaries
  github-release:
    needs: [release-info, build-binaries]
    if: inputs.github-release && needs.release-info.outputs.should_release == 'true'
    uses: ./.github/workflows/create-github-release.yml
    with:
      version: ${{ needs.release-info.outputs.version }}
      title: "${{ inputs.service-name }} v${{ needs.release-info.outputs.version }}"
      notes: ${{ needs.release-info.outputs.release_notes }}
      prerelease: ${{ inputs.prerelease }}
      artifact-name: ${{ inputs.binary-name }}
