name: 'Sync Crates Version'
description: 'Sync version across all workspace crates using cargo-release'

inputs:
  version:
    description: '[string] The version to set across all crates (e.g., 1.2.3)'
    required: true
  commit-changes:
    description: "[boolean: 'true'/'false'] Whether to commit and push version changes"
    required: false
    default: 'true'
  github-token:
    description: '[secret] GitHub token for pushing commits (required if commit-changes is true)'
    required: true
  app-id:
    description: '[secret] GitHub App ID for pushing to protected branches (optional)'
    required: false
    default: ''
  app-private-key:
    description: '[secret] GitHub App private key for pushing to protected branches (optional)'
    required: false
    default: ''

outputs:
  updated-crates:
    description: 'JSON array of crate names that were updated'
    value: ${{ steps.sync.outputs.updated-crates }}

runs:
  using: 'composite'
  steps:
    - name: Generate App Token
      id: app-token
      if: ${{ inputs.app-id != '' && inputs.app-private-key != '' }}
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ inputs.app-id }}
        private-key: ${{ inputs.app-private-key }}

    - name: Configure git remote with token
      shell: bash
      env:
        APP_TOKEN: ${{ steps.app-token.outputs.token }}
        FALLBACK_TOKEN: ${{ inputs.github-token }}
      run: |
        TOKEN="${APP_TOKEN:-$FALLBACK_TOKEN}"
        git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git"

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-edit
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-edit

    - name: Configure git
      shell: bash
      run: |
        git config user.name "photon-release[bot]"
        git config user.email "photon-release[bot]@users.noreply.github.com"

    - name: Sync workspace version
      id: sync
      shell: bash
      run: |
        VERSION="${{ inputs.version }}"
        
        echo "Setting all workspace crates to version ${VERSION}..."
        
        # Use 'cargo set-version' to set version across all workspace crates
        # This doesn't do any git checks - just updates Cargo.toml files
        cargo set-version --workspace ${VERSION}
        
        # Get updated crates for output (use -c for compact single-line JSON)
        UPDATED_CRATES=$(cargo metadata --no-deps --format-version 1 | jq -c '[.packages[].name]')
        echo "updated-crates=${UPDATED_CRATES}" >> $GITHUB_OUTPUT
        
        echo ""
        echo "Updated crates to version ${VERSION}:"
        cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | "  - \(.name): \(.version)"'

    - name: Commit and push changes
      if: inputs.commit-changes == 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        VERSION="${{ inputs.version }}"
        
        # Stage all changed files
        git add -A
        
        # Commit and push
        if ! git diff --staged --quiet; then
          git commit -m "chore: bump version to ${VERSION}"
          git push
        else
          echo "No changes to commit"
        fi
